<%- include('../shared/top', { title }) %>

<div class="row" style="justify-content:space-between; align-items:flex-end; margin-bottom:12px">
  <div>
    <h1 class="h1" style="margin:0">Receipt</h1>
    <div class="muted small">Order <%= order.order_code || ('#' + order.order_id) %> · <%= formatDateTime(order.created_at) %></div>
  </div>

  <div class="actions icon-row">
    <a class="btn btn-icon" href="/orders/<%= order.order_id %><%= token ? ('?t=' + encodeURIComponent(token)) : '' %>" title="Back" aria-label="Back" data-label="Back"><%- icon('back') %></a>

    <button class="btn btn-primary" type="button" data-download-receipt-pdf data-receipt-target="receipt" data-label="Download PDF" data-download-name="receipt_<%= order.order_code || order.order_id %>.pdf">Download PDF</button>
    <button class="btn" type="button" data-download-receipt-png data-receipt-target="receipt" data-label="Download PNG" data-download-name="receipt_<%= order.order_code || order.order_id %>.png">Download PNG</button>
  </div>
</div>

<div id="receipt" class="receipt-sheet">
  <div class="receipt-header">
    <div class="receipt-brand">
      <% if (siteLogoUrl) { %>
        <img class="receipt-logo" src="<%= siteLogoUrl %>" alt="<%= siteName || 'Visolux' %>" loading="lazy" decoding="async" />
      <% } %>
      <div>
        <div class="receipt-site-name"><%= siteName || 'Visolux' %></div>
        <div class="muted small">Receipt</div>
      </div>
    </div>

    <div class="receipt-meta">
      <div class="muted small">Order</div>
      <div class="receipt-order-code"><%= order.order_code || ('#' + order.order_id) %></div>
      <div class="muted small" style="margin-top:4px"><%= formatDateTime(order.created_at) %></div>
    </div>
  </div>

  <div class="receipt-grid">
    <div class="receipt-block">
      <div class="muted small">Bill to</div>
      <div class="receipt-strong"><%= order.customer_name %></div>
      <div class="muted small"><%= order.email %> · <%= order.phone %></div>
      <div class="muted small" style="margin-top:6px"><%= order.address %></div>
    </div>
    <div class="receipt-block">
      <div class="muted small">Payment</div>
      <div class="receipt-strong"><%= order.payment_method %></div>
      <div class="muted small" style="margin-top:8px">Status</div>
      <div class="receipt-strong"><%= order.payment_status %></div>
    </div>
  </div>

  <h2 class="h2" style="margin-top:16px">Items</h2>
  <table class="table receipt-table" style="margin-top:8px">
    <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr></thead>
    <tbody>
      <% (order.items || []).forEach(it => { %>
        <tr>
          <td><%= it.product_name_snapshot %></td>
          <td><%= formatMoney(it.price_snapshot) %></td>
          <td><%= it.quantity %></td>
          <td><%= formatMoney(it.subtotal) %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <% const itemsSubtotal = (order.items_subtotal != null ? order.items_subtotal : (order.items || []).reduce((a, it) => a + Number(it.subtotal || 0), 0)); %>
  <% const discountAmount = Number(order.discount_amount || 0); %>
  <% const shippingFee = Number(order.shipping_fee || 0); %>
  <% const totalWeightKg = (order.items || []).reduce((sum, it) => sum + (Number(it.weight_kg || 0) * Number(it.quantity || 0)), 0); %>

  <div class="receipt-summary">
    <div class="card" style="padding:12px; min-width:320px; box-shadow:none">
      <div class="kv"><span class="muted">Items subtotal</span> <strong><%= formatMoney(itemsSubtotal) %></strong></div>
      <% if (discountAmount > 0) { %>
        <div class="kv" style="margin-top:6px"><span class="muted">Discount</span> <strong>-<%= formatMoney(discountAmount) %></strong></div>
      <% } %>
      <div class="kv" style="margin-top:6px"><span class="muted">Shipping</span> <strong><%= formatMoney(shippingFee) %></strong></div>
      <div class="kv" style="margin-top:6px"><span class="muted">Total weight</span> <strong><%= Number(totalWeightKg || 0).toFixed(2) %> kg</strong></div>
      <div class="kv" style="margin-top:6px"><span class="muted">Total</span> <strong><%= formatMoney(order.total_amount) %></strong></div>
    </div>
  </div>

  <div class="muted small" style="margin-top:10px">Thank you for your purchase.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
<script src="/public/js/receipt-download.js" defer></script>

<%- include('../shared/bottom') %>
