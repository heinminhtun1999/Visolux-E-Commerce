<%- include('../shared/top', { title }) %>

<div class="row">
  <div class="col" style="min-width:320px">
    <div class="card" style="padding:16px">
      <h1 class="h1">Checkout</h1>
      <form method="post" action="/checkout" id="checkoutForm" novalidate>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <label>Customer name</label>
        <input class="input" name="customer_name" minlength="2" required value="<%= prefill ? (prefill.customer_name || '') : '' %>" />

        <label>Phone</label>
        <input class="input" name="phone" minlength="6" required value="<%= prefill ? (prefill.phone || '') : '' %>" />

        <label>Email</label>
        <input class="input" name="email" type="email" required value="<%= prefill ? (prefill.email || '') : '' %>" />

        <h2 class="h2" style="margin-top:12px">Delivery address (Malaysia)</h2>

        <label>Address line 1</label>
        <input class="input" name="address_line1" minlength="3" required value="<%= prefill ? (prefill.address_line1 || '') : '' %>" />

        <label>Address line 2 (optional)</label>
        <input class="input" name="address_line2" value="<%= prefill ? (prefill.address_line2 || '') : '' %>" />

        <label>City</label>
        <input class="input" name="city" minlength="2" required value="<%= prefill ? (prefill.city || '') : '' %>" />

        <label>State</label>
        <select class="input" name="state" id="stateSelect" required>
          <option value="">Select state</option>
          <% (malaysiaStates || []).forEach(s => { %>
            <option value="<%= s %>" <%= (prefill && prefill.state === s ? 'selected' : '') %>><%= s %></option>
          <% }) %>
        </select>

        <label>Postcode</label>
        <input class="input" name="postcode" inputmode="numeric" pattern="\d{5}" required value="<%= prefill ? (prefill.postcode || '') : '' %>" />

        <div class="muted small" style="margin-top:6px">
          Delivery zone: <strong id="regionLabel"><%= (typeof prefillShippingLabel !== 'undefined' && prefillShippingLabel) ? prefillShippingLabel : '-' %></strong>
          <span id="shippingMessage" class="muted" style="margin-left:8px"></span>
        </div>

        <label>Promo code (optional)</label>
        <div class="row" style="gap:10px; align-items:center">
          <input class="input" name="promo_code" id="promoCodeInput" placeholder="WELCOME10" style="flex:1" />
          <button class="btn" type="button" id="promoCheckBtn">Check</button>
        </div>
        <div class="muted small" id="promoMessage" style="margin-top:6px"></div>

        <label>Payment method</label>
        <select name="payment_method" id="paymentMethodSelect" required>
          <% if (canOnlinePay) { %>
            <option value="ONLINE">Online payment</option>
          <% } %>
          <option value="OFFLINE_TRANSFER">Offline bank transfer (upload slip)</option>
        </select>

        <div class="card" id="offlineBankDetails" style="padding:12px; margin-top:12px; display:none">
          <div class="muted small" style="font-weight:800; letter-spacing:.02em; text-transform:uppercase">Offline bank transfer details</div>
          <div style="margin-top:8px" class="small">
            <div><strong>Bank Acc.</strong>: Public Bank Berhad</div>
            <div><strong>Acc. No.</strong>: 3140814122</div>
            <div><strong>Acc. Name</strong>: Visolux (M) Sdn Bhd</div>
          </div>
          <div class="muted small" style="margin-top:8px">After payment, upload your bank slip for verification.</div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn btn-primary" id="placeOrderBtn" type="submit">Place order</button>
          <a class="btn" href="/">Cancel</a>
        </div>

        <div id="checkoutFormMessage" class="muted small" style="margin-top:8px"></div>

        <div class="muted small" style="margin-top:10px">
          <% if (!canOnlinePay) { %>
            Online payment is currently disabled until Fiuu credentials are configured.
          <% } %>
        </div>
      </form>
    </div>
  </div>

  <div class="col" style="min-width:320px">
    <div class="card" style="padding:16px">
      <h2 class="h2">Order summary</h2>
      <div
        id="checkoutTotals"
        data-items-total-cents="<%= Number(cart.total || 0) %>"
        data-discount-cents="0"
        data-csrf-token="<%= csrfToken %>"
        style="display:none"
      ></div>
      <table class="table">
        <thead>
          <tr><th>Item</th><th>Qty</th><th>Subtotal</th></tr>
        </thead>
        <tbody>
          <% cart.items.forEach(line => { %>
            <tr>
              <td>
                <div style="font-weight:700"><%= line.product.name %></div>
                <div class="muted small"><%= formatMoney(line.product.price) %> each</div>
                <% if (line.product && line.product.weight_kg != null) { %>
                  <div class="muted small">Weight: <%= Number(line.product.weight_kg || 0).toFixed(2) %> kg</div>
                <% } %>
              </td>
              <td><%= line.quantity %></td>
              <td><%= formatMoney(line.subtotal) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <div class="kv" style="margin-top:10px">
        <span class="muted">Total weight</span>
        <strong><%= (typeof totalWeightKg !== 'undefined' ? Number(totalWeightKg || 0) : 0).toFixed(2) %> kg</strong>
      </div>
      <div class="kv" style="margin-top:10px"><span class="muted">Total</span> <strong><%= formatMoney(cart.total) %></strong></div>
      <div class="kv" style="margin-top:6px"><span class="muted">Courier charge</span> <strong id="shippingFee"><%= formatMoney(prefillShippingFee || 0) %></strong></div>
      <div class="kv" style="margin-top:6px"><span class="muted">Before discount</span> <strong id="preDiscountTotal"><%= formatMoney(cart.total + (prefillShippingFee || 0)) %></strong></div>
      <div class="kv" style="margin-top:6px"><span class="muted">Discount</span> <strong id="discountAmount"><%= formatMoney(0) %></strong></div>
      <div class="kv" style="margin-top:6px"><span class="muted">Grand total</span> <strong id="grandTotal"><%= formatMoney(cart.total + (prefillShippingFee || 0)) %></strong></div>
      <div class="muted small" style="margin-top:8px">
        Courier charge depends on your delivery zone and total cart weight.
      </div>
    </div>
  </div>
</div>

<script src="/public/js/checkout-shipping.js?v=3" defer></script>
<script src="/public/js/checkout-promo.js?v=3" defer></script>

<%- include('../shared/bottom') %>
