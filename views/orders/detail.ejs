<%- include('../shared/top', { title }) %>

<div class="card" style="padding:16px">
  <h1 class="h1">Order <%= order.order_code || ('#' + order.order_id) %></h1>

  <div class="row" style="gap:18px">
    <div class="col">
      <div class="muted small">Customer</div>
      <div style="font-weight:700"><%= order.customer_name %></div>
      <div class="muted small"><%= order.email %> • <%= order.phone %></div>
      <div class="muted small" style="margin-top:6px"><%= order.address %></div>
    </div>
    <div style="min-width:240px">
      <div class="muted small">Payment method</div>
      <div style="font-weight:800"><%= order.payment_method %></div>
      <div class="muted small" style="margin-top:8px">Payment status</div>
      <div style="font-weight:800"><%= order.payment_status %></div>
      <div class="muted small" style="margin-top:8px">Fulfilment</div>
      <div style="font-weight:800"><%= order.fulfilment_status %></div>
    </div>
  </div>

  <% if (statusHistory && statusHistory.length) { %>
    <div class="card" style="padding:12px; margin-top:12px">
      <h2 class="h2">Status history</h2>
      <div class="timeline">
        <% statusHistory.forEach((h, idx) => { %>
          <div class="timeline-item">
            <div class="timeline-gutter">
              <div class="timeline-dot"></div>
              <% if (idx < statusHistory.length - 1) { %><div class="timeline-line"></div><% } %>
            </div>
            <div class="timeline-body">
              <div class="timeline-top">
                <div class="timeline-title">
                  <span class="badge" style="margin-right:8px"><%= h.status_type %></span>
                  <strong>
                    <%= h.old_status ? (h.old_status + ' → ' + h.new_status) : h.new_status %>
                  </strong>
                </div>
                <div class="timeline-time muted small"><%= formatDateTime(h.changed_at) %></div>
              </div>
              <% if (h.note) { %>
                <div class="muted small" style="margin-top:4px"><%= h.note %></div>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>

  <% if (promo) { %>
    <div class="muted small" style="margin-top:10px">
      Promo: <strong><%= promo.code %></strong>
      <% if (Number(promo.percent_off || 0) > 0) { %>
        (-<%= promo.percent_off %>%)
      <% } %>
      <span class="muted">•</span> Discount: <strong><%= formatMoney(promo.discount_amount) %></strong>
    </div>
  <% } %>

  <h2 class="h2" style="margin-top:14px">Items</h2>
  <table class="table">
    <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr></thead>
    <tbody>
      <% order.items.forEach(it => { %>
        <tr>
          <td><%= it.product_name_snapshot %></td>
          <td><%= formatMoney(it.price_snapshot) %></td>
          <td><%= it.quantity %></td>
          <td><%= formatMoney(it.subtotal) %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <% const itemsSubtotal = (order.items_subtotal != null ? order.items_subtotal : (order.items || []).reduce((a, it) => a + Number(it.subtotal || 0), 0)); %>
  <% const discountAmount = (order.discount_amount != null ? order.discount_amount : (promo ? promo.discount_amount : 0)); %>
  <% const shippingFee = Number(order.shipping_fee || 0); %>

  <div class="row" style="justify-content:flex-end; margin-top:10px">
    <div class="card" style="padding:12px; min-width:280px">
      <div class="kv"><span class="muted">Items subtotal</span> <strong><%= formatMoney(itemsSubtotal) %></strong></div>
      <% if (discountAmount > 0) { %>
        <div class="kv" style="margin-top:6px"><span class="muted">Discount</span> <strong>-<%= formatMoney(discountAmount) %></strong></div>
      <% } %>
      <div class="kv" style="margin-top:6px"><span class="muted">Courier charge</span> <strong><%= formatMoney(shippingFee) %></strong></div>
      <div class="kv" style="margin-top:6px"><span class="muted">Total</span> <strong><%= formatMoney(order.total_amount) %></strong></div>
      <% if (order.delivery_region) { %>
        <div class="muted small" style="margin-top:8px">Delivery region: <strong><%= order.delivery_region === 'EAST' ? 'East Malaysia' : 'West Malaysia' %></strong></div>
      <% } %>
    </div>
  </div>

  <% if ((itemRefunds && itemRefunds.length) || (extraRefunds && extraRefunds.length)) { %>
    <div class="card" style="padding:12px; margin-top:12px">
      <h2 class="h2">Refund history</h2>
      <div class="muted small">Refunds recorded for this order.</div>

      <% if (itemRefunds && itemRefunds.length) { %>
        <div style="margin-top:10px">
          <div class="muted small" style="font-weight:800; letter-spacing:.02em; text-transform:uppercase">Item refunds</div>
          <table class="table" style="margin-top:8px">
            <thead><tr><th>When</th><th>Qty</th><th>Amount</th><th>Provider</th><th>Status</th><th>Reason</th></tr></thead>
            <tbody>
              <% itemRefunds.forEach(r => { %>
                <tr>
                  <td class="muted"><%= formatDateTime(r.created_at) %></td>
                  <td class="muted"><%= r.quantity_refunded %></td>
                  <td>RM <%= formatMoney(r.amount_refunded) %></td>
                  <td class="muted"><%= r.provider || '-' %></td>
                  <td class="muted"><%= r.provider_status || '-' %></td>
                  <td class="muted"><%= r.reason || '' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>

      <% if (extraRefunds && extraRefunds.length) { %>
        <div style="margin-top:10px">
          <div class="muted small" style="font-weight:800; letter-spacing:.02em; text-transform:uppercase">Extra refunds</div>
          <table class="table" style="margin-top:8px">
            <thead><tr><th>When</th><th>Amount</th><th>Provider</th><th>Status</th><th>Reason</th></tr></thead>
            <tbody>
              <% extraRefunds.forEach(r => { %>
                <tr>
                  <td class="muted"><%= formatDateTime(r.created_at) %></td>
                  <td>RM <%= formatMoney(r.amount_refunded) %></td>
                  <td class="muted"><%= r.provider || '-' %></td>
                  <td class="muted"><%= r.provider_status || '-' %></td>
                  <td class="muted"><%= r.reason || '' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  <% } %>

  <% if (order.payment_method === 'OFFLINE_TRANSFER') { %>
    <div style="margin-top:14px" class="card">
      <div style="padding:12px">
        <h2 class="h2">Bank transfer slip</h2>
          <div class="card" style="padding:12px; margin-top:10px">
            <div class="muted small" style="font-weight:800; letter-spacing:.02em; text-transform:uppercase">Bank details</div>
            <div style="margin-top:8px" class="small">
              <div><strong>Bank Acc.</strong>: Public Bank Berhad</div>
              <div><strong>Acc. No.</strong>: 3140814122</div>
              <div><strong>Acc. Name</strong>: Visolux (M) Sdn Bhd</div>
            </div>
          </div>
        <% if (offline) { %>
          <div class="muted small">Bank: <%= offline.bank_name %> • Ref: <%= offline.reference_number %></div>
          <% if (!offline.verified && offline.slip_rejection_reason) { %>
            <div class="card" style="padding:10px; margin-top:10px; border:1px solid rgba(220,53,69,.35); background:rgba(220,53,69,.06)">
              <div style="font-weight:800">Slip rejected</div>
              <div class="muted small" style="margin-top:4px">
                <%= offline.slip_rejection_reason %>
                <% if (offline.slip_rejected_at) { %> • <%= formatDateTime(offline.slip_rejected_at) %><% } %>
              </div>
            </div>
          <% } %>
          <div style="margin-top:10px" class="row">
            <div style="flex:1">
              <% if (offline.slip_deleted) { %>
                <div class="muted" style="padding:12px; border:1px dashed var(--border); border-radius:10px">
                  Slip image purged<% if (offline.slip_deleted_at) { %> on <%= formatDateTime(offline.slip_deleted_at) %><% } %>.
                </div>
              <% } else { %>
                <button type="button" class="slip-thumb" data-slip-open data-slip-src="<%= offline.slip_image_path %>" aria-label="Open slip">
                  <img class="product-img" style="height:220px" src="<%= offline.slip_image_path %>" alt="" />
                </button>
              <% } %>
            </div>
            <div style="min-width:240px">
              <% if (offline.verified) { %>
                <span class="badge ok">Verified</span>
              <% } else { %>
                <span class="badge">Pending review</span>
              <% } %>
              <div class="actions" style="margin-top:10px">
                <% if (!offline.verified && !offline.slip_deleted) { %>
                  <a class="btn" href="/orders/<%= order.order_id %>/offline-transfer">Replace slip</a>
                <% } %>
              </div>
            </div>
          </div>
        <% } else { %>
          <div class="muted">No slip uploaded yet.</div>
          <div class="actions" style="margin-top:10px">
            <a class="btn btn-primary" href="/orders/<%= order.order_id %>/offline-transfer">Upload slip</a>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
</div>

<% if (order.payment_method === 'OFFLINE_TRANSFER' && offline && !offline.slip_deleted) { %>
  <div class="modal" data-slip-modal aria-hidden="true">
    <div class="modal__backdrop" data-modal-backdrop></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-label="Bank slip viewer">
      <div class="modal__top">
        <div class="modal__title">Bank transfer slip</div>
        <button class="btn btn-icon icon-only" type="button" data-modal-close title="Close" aria-label="Close" data-label="Close"><%- icon('x') %></button>
      </div>
      <div class="modal__body">
        <div class="zoom-pane" data-zoom-pane>
          <img data-zoom-img data-slip-modal-img src="<%= offline.slip_image_path %>" alt="" />
        </div>
        <div class="muted small" style="margin-top:8px">Scroll/pinch to zoom, drag to pan, double-click to reset.</div>
      </div>
    </div>
  </div>
  <script src="/public/js/zoom-pan.js" defer></script>
  <script src="/public/js/slip-viewer.js" defer></script>
<% } %>

<%- include('../shared/bottom') %>
