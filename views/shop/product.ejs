<%- include('../shared/top', { title }) %>

<div class="card" style="padding:16px">
  <div class="row">
    <div style="flex:1">
      <% const galleryUrls = []; %>
      <% if (product && product.product_image) galleryUrls.push(product.product_image); %>
      <% (images || []).forEach(img => { if (img && img.image_url) galleryUrls.push(img.image_url); }); %>
      <% const uniqGallery = [...new Set(galleryUrls.filter(Boolean))]; %>
      <% const mainImg = (uniqGallery[0] || product.product_image || '/public/placeholder.svg'); %>
      <% const encodedGallery = uniqGallery.map(u => encodeURIComponent(u)).join('|'); %>

      <div data-image-carousel data-items="<%= encodedGallery %>">
        <div class="zoom-pane" data-zoom-pane>
          <div class="product-carousel">
            <img data-zoom-img data-carousel-img src="<%= mainImg %>" alt="" />
            <% if (uniqGallery.length > 1) { %>
              <button class="product-carousel__btn product-carousel__btn--prev" type="button" data-carousel-prev aria-label="Previous image">‹</button>
              <button class="product-carousel__btn product-carousel__btn--next" type="button" data-carousel-next aria-label="Next image">›</button>
            <% } %>
          </div>
          <% if (product.stock <= 0) { %>
            <div class="product-stock-overlay" aria-label="Out of stock">Out of stock</div>
          <% } %>
        </div>

        <% if (uniqGallery.length > 1) { %>
          <div class="product-gallery">
            <% uniqGallery.forEach((url, idx) => { %>
              <button class="product-gallery__thumb <%= idx === 0 ? 'is-active' : '' %>" type="button" data-carousel-thumb data-idx="<%= idx %>" aria-label="View image <%= idx + 1 %>">
                <img src="<%= url %>" alt="" loading="lazy" decoding="async" />
              </button>
            <% }) %>
          </div>
        <% } %>
      </div>

      <div class="muted small" style="margin-top:8px">Scroll/pinch to zoom, drag to pan, double-click to reset.</div>
    </div>
    <div style="flex:1">
      <h1 class="h1"><%= product.name %></h1>
      <div class="muted"><%= product.category_name || product.category %></div>
      <div style="margin-top:10px; font-size:18px; font-weight:800"><%= formatMoney(product.price) %></div>
      <div style="margin-top:10px">
        <% if (product.stock > 0) { %>
          <span class="badge ok">In stock: <%= product.stock %></span>
        <% } else { %>
          <span class="badge no">Out of stock</span>
        <% } %>
      </div>
      <div style="margin-top:12px" class="muted">
        <% if (String(product.description_html || '').trim()) { %>
          <div class="md"><%- product.description_html %></div>
        <% } else { %>
          <p class="muted"><%= product.description %></p>
        <% } %>
      </div>

      <% if (!isAdmin) { %>
        <form method="post" action="/cart/add" style="margin-top:12px" class="row">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <input type="hidden" name="product_id" value="<%= product.product_id %>" />
          <input type="hidden" name="return_to" value="<%= currentUrl %>" />
          <div style="width:140px">
            <label>Qty</label>
            <input class="input" type="number" name="quantity" min="1" max="99" value="1" />
          </div>
          <div style="flex:1">
            <label>&nbsp;</label>
            <button class="btn btn-primary" type="submit" <%= product.stock > 0 ? '' : 'disabled' %>>Add to cart</button>
          </div>
        </form>
      <% } %>
    </div>
  </div>
</div>

<script src="/public/js/zoom-pan.js" defer></script>
<script src="/public/js/image-carousel.js" defer></script>

<%- include('../shared/bottom') %>
