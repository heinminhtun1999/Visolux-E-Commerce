<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <% const baseTitle = (siteName || 'Visolux Store'); %>
  <% const rawTitle = (title || '').trim(); %>
  <% const pageTitle = rawTitle ? ((rawTitle === baseTitle) ? baseTitle : `${rawTitle} | ${baseTitle}`) : baseTitle; %>
  <% const metaDescription = (description || seoDescription || siteDescription || 'Visolux Store â€” shop parts and components online.'); %>
  <% const canonical = canonicalUrl || (siteUrl ? (siteUrl.replace(/\/+$/,'') + (currentPath || '/')) : (currentPath || '/')); %>
  <% const robots = robotsMeta || ((currentPath || '').startsWith('/admin') ? 'noindex,nofollow' : 'index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1'); %>
  <% const ogTitle = ogTitleOverride || pageTitle; %>
  <% const ogDesc = ogDescriptionOverride || metaDescription; %>
  <% const ogUrl = ogUrlOverride || canonical; %>
  <% const ogImage = ogImageUrl || siteOgImageUrl || siteLogoUrl || '/public/placeholder.svg'; %>
  <% const ogType = ogTypeOverride || 'website'; %>

  <title><%= pageTitle %></title>
  <meta name="description" content="<%= metaDescription %>" />
  <link rel="canonical" href="<%= canonical %>" />
  <meta name="robots" content="<%= robots %>" />

  <meta property="og:site_name" content="<%= siteName || 'Visolux Store' %>" />
  <meta property="og:title" content="<%= ogTitle %>" />
  <meta property="og:description" content="<%= ogDesc %>" />
  <meta property="og:type" content="<%= ogType %>" />
  <meta property="og:url" content="<%= ogUrl %>" />
  <meta property="og:image" content="<%= ogImage %>" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="<%= ogTitle %>" />
  <meta name="twitter:description" content="<%= ogDesc %>" />
  <meta name="twitter:image" content="<%= ogImage %>" />

  <% const faviconHref = siteLogoUrl || '/public/placeholder.svg'; %>
  <link rel="icon" href="<%= faviconHref %>" />
  <link rel="apple-touch-icon" href="<%= faviconHref %>" />
  <link rel="manifest" href="/public/site.webmanifest" />
  <script>
    // Apply theme before CSS loads to avoid flash.
    (function () {
      try {
        var t = localStorage.getItem('theme');
        if (t !== 'dark' && t !== 'light') {
          t = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        }
        document.documentElement.dataset.theme = t;
      } catch (_) {
        // ignore
      }
    })();
  </script>
  <link rel="stylesheet" href="/public/css/app.css" />

  <% if (structuredData && Array.isArray(structuredData) && structuredData.length) { %>
    <% structuredData.forEach(function(obj){ %>
      <script type="application/ld+json"><%- JSON.stringify(obj) %></script>
    <% }) %>
  <% } %>
</head>
<% const isAdminArea = (currentPath || '').startsWith('/admin'); %>
<body class="<%= isAdminArea ? 'is-admin' : 'is-store' %>">
  <div class="container <%= (typeof containerClass !== 'undefined' && containerClass) ? containerClass : '' %>">


    <header class="site-header site-header--sticky" style="margin-top:10px; margin-bottom:12px">
      <div class="site-header__brand">
        <% if (isAdminArea) { %>
          <button class="btn btn-icon icon-only" type="button" data-admin-sidebar-toggle title="Toggle sidebar" aria-label="Toggle sidebar" data-label="Toggle sidebar"><%- icon('panel-left') %></button>
        <% } %>

        <a class="site-brand" href="/" aria-label="Home">
          <% if (siteLogoUrl) { %>
            <img src="<%= siteLogoUrl %>" alt="<%= siteName || 'Home' %>" />
          <% } else { %>
            <span class="site-brand__text"><%= siteName || 'Visolux' %></span>
          <% } %>
        </a>
      </div>

      <% if (!isAdminArea) { %>
        <nav class="store-nav" aria-label="Store navigation">
          <a class="store-nav__link <%= (currentPath || '') === '/' ? 'is-active' : '' %>" href="/">Home</a>

          <div class="store-nav__dropdown">
            <button type="button" class="store-nav__link store-nav__linkBtn" aria-haspopup="menu">
              Categories
              <span class="store-nav__chev" aria-hidden="true"><%- icon('chevron-down', { size: 16 }) %></span>
            </button>
            <div class="store-nav__menu">
              <% const cats = (typeof navCategories !== 'undefined' && Array.isArray(navCategories)) ? navCategories : []; %>
              <a class="store-nav__menuItem" href="/products">All products</a>
              <% if (cats.length) { %>
                <div class="store-nav__menuDivider"></div>
                <% cats.forEach(function(c){ %>
                  <a class="store-nav__menuItem" href="/categories/<%= encodeURIComponent(c.slug) %>"><%= c.name %></a>
                <% }) %>
              <% } %>
            </div>
          </div>

          <a class="store-nav__link <%= (currentPath || '').startsWith('/how-to-order') ? 'is-active' : '' %>" href="/how-to-order">How to order</a>
        </nav>
      <% } %>

      <div class="site-header__actions actions icon-row">
        <button class="btn btn-icon icon-only" type="button" id="themeToggle" title="Toggle Dark mode" aria-label="Toggle Dark mode" data-label="Theme">
          <span class="theme-icon theme-icon--sun"><%- icon('sun') %></span>
          <span class="theme-icon theme-icon--moon"><%- icon('moon') %></span>
        </button>

        <% const showAdminBell = isAdmin; %>
        <% const showAdminLink = isAdmin && !isAdminArea; %>

        <% if (!isAdmin) { %>
          <a class="btn btn-icon <%= (currentPath || '').startsWith('/cart') ? 'is-active' : '' %>" href="/cart" title="Cart" aria-label="Cart" data-label="Cart">
            <%- icon('cart') %>
            <span class="btn-text">Cart</span>
            <% if (cartItemCount > 0) { %><span class="btn-badge" aria-label="<%= cartItemCount %> items in cart"><%= cartItemCount %></span><% } %>
          </a>
        <% } %>

        <% if (currentUser && !isAdmin) { %>
          <a class="btn btn-icon <%= (currentPath || '').startsWith('/orders') ? 'is-active' : '' %>" href="/orders/history" title="Orders" aria-label="Orders" data-label="Orders">
            <%- icon('orders') %>
            <span class="btn-text">Orders</span>
          </a>
          <a class="btn btn-icon <%= (currentPath || '').startsWith('/account') ? 'is-active' : '' %>" href="/account" title="Account" aria-label="Account" data-label="Account">
            <%- icon('user') %>
            <span class="btn-text">Account</span>
          </a>
        <% } %>

        <% if (!currentUser) { %>
          <a class="btn btn-icon <%= (currentPath || '').startsWith('/login') ? 'is-active' : '' %>" href="/login" title="Sign in" aria-label="Sign in" data-label="Sign in">
            <%- icon('login') %>
            <span class="btn-text">Sign in</span>
          </a>
        <% } %>

        <% if (showAdminBell) { %>
          <a class="btn btn-icon icon-only" href="/admin/notifications" title="Notifications" aria-label="Notifications" data-label="Notifications" data-admin-notification-bell>
            <%- icon('bell') %>
            <% if ((adminUnreadNotificationCount || 0) > 0) { %><span class="btn-badge"><%= adminUnreadNotificationCount %></span><% } %>
          </a>
        <% } %>

        <% if (isAdmin) { %>
          <a class="btn btn-icon icon-only" href="/admin/contact-messages" title="Contact messages" aria-label="Contact messages" data-label="Contact messages">
            <%- icon('mail') %>
            <% if ((adminUnreadContactMessageCount || 0) > 0) { %><span class="btn-badge"><%= adminUnreadContactMessageCount %></span><% } %>
          </a>
        <% } %>

        <% if (showAdminLink) { %>
          <a class="btn btn-icon icon-only" href="/admin" title="Admin" aria-label="Admin" data-label="Admin"><%- icon('admin') %></a>
        <% } %>

        <% if (currentUser) { %>
          <form method="post" action="/logout" style="display:inline">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <button class="btn btn-icon icon-only" type="submit" title="Sign out" aria-label="Sign out" data-label="Sign out"><%- icon('logout') %></button>
          </form>
        <% } %>
      </div>
    </header>

    <% if (breadcrumbs && breadcrumbs.length) { %>
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <% breadcrumbs.forEach((c, idx) => { %>
          <% const isLast = idx === breadcrumbs.length - 1; %>
          <% if (!c || !c.label) return; %>
          <% if (isLast) { %>
            <span class="breadcrumbs__current" aria-current="page"><%= c.label %></span>
          <% } else { %>
            <a class="breadcrumbs__link" href="<%= c.href %>"><%= c.label %></a>
            <span class="breadcrumbs__sep" aria-hidden="true">/</span>
          <% } %>
        <% }) %>
      </nav>
    <% } %>

    <% if (typeof flash !== 'undefined' && flash) { %>
      <div class="flash <%= flash.type %>" data-flash role="status" aria-live="polite">
        <div class="flash__row">
          <div class="flash__msg"><%= flash.message %></div>
          <button class="flash__close" type="button" data-flash-close aria-label="Dismiss">
            <%- icon('x', { size: 18 }) %>
          </button>
        </div>
      </div>
    <% } %>

    <% if (isAdminArea) { %>
      <div class="admin-shell">
        <aside class="admin-sidebar" aria-label="Admin navigation">
          <div class="admin-sidebar__inner">
            <div class="admin-nav__section">Catalog</div>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/products') ? 'is-active' : '' %>" href="/admin/products">
              <span class="admin-nav__icon"><%- icon('box') %></span>
              <span class="admin-nav__label">Products</span>
            </a>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/categories') ? 'is-active' : '' %>" href="/admin/categories">
              <span class="admin-nav__icon"><%- icon('layers') %></span>
              <span class="admin-nav__label">Categories</span>
            </a>

            <div class="admin-nav__section">Sales</div>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/orders') ? 'is-active' : '' %>" href="/admin/orders">
              <span class="admin-nav__icon"><%- icon('shopping-bag') %></span>
              <span class="admin-nav__label">Orders</span>
            </a>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/reports/sales') ? 'is-active' : '' %>" href="/admin/reports/sales">
              <span class="admin-nav__icon"><%- icon('bar-chart-3') %></span>
              <span class="admin-nav__label">Sales report</span>
            </a>

            <div class="admin-nav__section">People</div>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/users') ? 'is-active' : '' %>" href="/admin/users">
              <span class="admin-nav__icon"><%- icon('users') %></span>
              <span class="admin-nav__label">Users</span>
            </a>

            <div class="admin-nav__section">Comms</div>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/notifications') ? 'is-active' : '' %>" href="/admin/notifications">
              <span class="admin-nav__icon"><%- icon('bell') %></span>
              <span class="admin-nav__label">Notifications</span>
            </a>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/contact-messages') ? 'is-active' : '' %>" href="/admin/contact-messages">
              <span class="admin-nav__icon"><%- icon('mail') %></span>
              <span class="admin-nav__label">Contact messages</span>
            </a>

            <div class="admin-nav__section">Content</div>
            <a class="admin-nav__item <%= (currentPath || '') === '/admin/pages/privacy' ? 'is-active' : '' %>" href="/admin/pages/privacy">
              <span class="admin-nav__icon"><%- icon('file-text') %></span>
              <span class="admin-nav__label">Privacy</span>
            </a>
            <a class="admin-nav__item <%= (currentPath || '') === '/admin/pages/terms' ? 'is-active' : '' %>" href="/admin/pages/terms">
              <span class="admin-nav__icon"><%- icon('file-text') %></span>
              <span class="admin-nav__label">Terms</span>
            </a>
            <a class="admin-nav__item <%= (currentPath || '') === '/admin/pages/how-to-order' ? 'is-active' : '' %>" href="/admin/pages/how-to-order">
              <span class="admin-nav__icon"><%- icon('file-text') %></span>
              <span class="admin-nav__label">How to order</span>
            </a>

            <div class="admin-nav__section">System</div>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/site/shipping-zones') ? 'is-active' : '' %>" href="/admin/site/shipping-zones">
              <span class="admin-nav__icon"><%- icon('sliders-horizontal') %></span>
              <span class="admin-nav__label">Shipping</span>
            </a>
            <a class="admin-nav__item <%= (currentPath || '').startsWith('/admin/settings') ? 'is-active' : '' %>" href="/admin/settings">
              <span class="admin-nav__icon"><%- icon('settings') %></span>
              <span class="admin-nav__label">Settings</span>
            </a>
          </div>
        </aside>
        <main class="admin-main">
    <% } %>

    <script src="/public/js/table-sort.js" defer></script>
    <script src="/public/js/theme-toggle.js" defer></script>
    <script src="/public/js/flash-dismiss.js" defer></script>
    <% if (isAdmin && (currentPath || '').startsWith('/admin')) { %>
      <script src="/public/js/admin-notifications.js" defer></script>
      <script src="/public/js/admin-sidebar.js" defer></script>
    <% } %>

