<%- include('../shared/top', { title }) %>

<div class="row" style="justify-content:space-between; align-items:flex-end">
  <div>
    <h1 class="h1">Admin – Sales report</h1>
    <div class="muted small">Paid orders and confirmed refunds in the selected date range.</div>
  </div>
  <div class="actions icon-row">
    <a class="btn btn-icon icon-only" href="/admin/orders" title="Orders" aria-label="Orders" data-label="Orders"><%- icon('orders') %></a>
    <a class="btn btn-icon icon-only" href="/admin/products" title="Products" aria-label="Products" data-label="Products"><%- icon('store') %></a>
    <a class="btn btn-icon icon-only" href="/admin/settings" title="Settings" aria-label="Settings" data-label="Settings"><%- icon('gear') %></a>
    <a class="btn btn-icon icon-only" href="/" title="Home" aria-label="Home" data-label="Home"><%- icon('home') %></a>
  </div>
</div>

<div class="card" style="padding:14px; margin-top:12px">
  <form method="get" action="/admin/reports/sales" class="admin-form">
    <div class="field is-sm">
      <label>From</label>
      <input class="input" type="date" name="date_from" value="<%= date_from || '' %>" />
    </div>
    <div class="field is-sm">
      <label>To</label>
      <input class="input" type="date" name="date_to" value="<%= date_to || '' %>" />
    </div>
    <div class="actions">
      <button class="btn btn-primary" type="submit">Run report</button>
      <% const qs = new URLSearchParams(); %>
      <% if (date_from) qs.set('date_from', date_from); %>
      <% if (date_to) qs.set('date_to', date_to); %>
      <a class="btn" href="/admin/reports/sales.csv?<%= qs.toString() %>">Download CSV</a>
    </div>
  </form>
</div>

<div class="row" style="gap:12px; flex-wrap:wrap; margin-top:12px">
  <div class="card" style="padding:14px; min-width:240px">
    <div class="muted small">Paid orders</div>
    <div style="font-size:20px; font-weight:800"><%= (summary && summary.orders_count != null) ? summary.orders_count : 0 %></div>
  </div>
  <div class="card" style="padding:14px; min-width:240px">
    <div class="muted small">Gross sales</div>
    <div style="font-size:20px; font-weight:800">RM <%= formatMoney((summary && summary.gross_cents) ? summary.gross_cents : 0) %></div>
  </div>
  <div class="card" style="padding:14px; min-width:240px">
    <div class="muted small">Refunds (confirmed)</div>
    <div style="font-size:20px; font-weight:800">RM <%= formatMoney((summary && summary.refund_cents) ? summary.refund_cents : 0) %></div>
  </div>
  <div class="card" style="padding:14px; min-width:240px">
    <div class="muted small">Net</div>
    <div style="font-size:20px; font-weight:800">RM <%= formatMoney((summary && summary.net_cents) ? summary.net_cents : 0) %></div>
  </div>
</div>

<div class="card" style="padding:14px; margin-top:12px">
  <h2 class="h2" style="margin-top:0">Daily</h2>
  <div class="muted small" style="margin-top:-6px">Gross is grouped by order created date; refunds are grouped by refund created date.</div>

  <div class="table-scroll" style="margin-top:10px">
    <table class="table">
      <thead>
        <tr><th>Date</th><th>Paid orders</th><th>Gross</th><th>Refunds</th><th>Net</th></tr>
      </thead>
      <tbody>
        <% if (daily && daily.length) { %>
          <% daily.forEach(r => { %>
            <tr>
              <td class="muted"><%= r.day %></td>
              <td><%= r.orders_count %></td>
              <td>RM <%= formatMoney(r.gross_cents || 0) %></td>
              <td>RM <%= formatMoney(r.refund_cents || 0) %></td>
              <td>RM <%= formatMoney(r.net_cents || 0) %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="5" class="muted">No data for this range.</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<div class="card" style="padding:14px; margin-top:12px">
  <h2 class="h2" style="margin-top:0">Top products</h2>
  <div class="muted small" style="margin-top:-6px">By gross item subtotal within paid orders.</div>

  <div class="table-scroll" style="margin-top:10px">
    <table class="table">
      <thead>
        <tr><th style="width:92px">Image</th><th>Product</th><th>Qty</th><th>Subtotal</th></tr>
      </thead>
      <tbody>
        <% if (topProducts && topProducts.length) { %>
          <% topProducts.forEach(p => { %>
            <tr>
              <td>
                <% const urls = (p.image_urls || []).filter(Boolean); %>
                <% const encoded = urls.map(u => encodeURIComponent(u)).join('|'); %>
                <div class="mini-carousel-wrap" data-image-carousel data-items="<%= encoded %>">
                  <div class="mini-carousel">
                    <img class="mini-carousel__img" data-carousel-img src="<%= urls[0] || '/public/placeholder.svg' %>" alt="" loading="lazy" decoding="async" />
                    <% if (urls.length > 1) { %>
                      <button class="mini-carousel__btn mini-carousel__btn--prev" type="button" data-carousel-prev aria-label="Previous image">‹</button>
                      <button class="mini-carousel__btn mini-carousel__btn--next" type="button" data-carousel-next aria-label="Next image">›</button>
                    <% } %>
                  </div>
                  <% if (urls.length > 1) { %>
                    <div class="mini-thumbs" aria-label="Product images">
                      <% urls.forEach((u, idx) => { %>
                        <button class="mini-thumb <%= idx === 0 ? 'is-active' : '' %>" type="button" data-carousel-thumb data-idx="<%= idx %>" aria-label="View image <%= idx + 1 %>">
                          <img src="<%= u %>" alt="" loading="lazy" decoding="async" />
                        </button>
                      <% }) %>
                    </div>
                  <% } %>
                </div>
              </td>
              <td><%= p.product_name %></td>
              <td><%= p.quantity %></td>
              <td>RM <%= formatMoney(p.subtotal_cents || 0) %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="4" class="muted">No data for this range.</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script src="/public/js/image-carousel.js" defer></script>

<%- include('../shared/bottom') %>
