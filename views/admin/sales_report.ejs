<%- include('../shared/top', { title, containerClass: 'container--wide' }) %>

<div class="row" style="justify-content:space-between; align-items:flex-end">
  <div>
    <h1 class="h1">Admin â€“ Sales report</h1>
    <div class="muted small">Paid orders and confirmed refunds in the selected date range.</div>
  </div>
</div>

<div class="card card--pad card--mt">
  <form method="get" action="/admin/reports/sales" class="admin-form">
    <div class="field is-sm">
      <label>From</label>
      <input class="input" type="date" name="date_from" value="<%= date_from || '' %>" />
    </div>
    <div class="field is-sm">
      <label>To</label>
      <input class="input" type="date" name="date_to" value="<%= date_to || '' %>" />
    </div>
    <div class="actions">
      <button class="btn btn-primary" type="submit">Run report</button>
      <% const qs = new URLSearchParams(); %>
      <% if (date_from) qs.set('date_from', date_from); %>
      <% if (date_to) qs.set('date_to', date_to); %>
      <a class="btn btn-secondary" href="/admin/reports/sales.csv?<%= qs.toString() %>">Download CSV</a>
    </div>
  </form>
</div>

<div class="stats-grid">
  <div class="card card--pad">
    <div class="stat__label">Paid orders</div>
    <div class="stat__value"><%= (summary && summary.orders_count != null) ? summary.orders_count : 0 %></div>
  </div>
  <div class="card card--pad">
    <div class="stat__label">Gross sales</div>
    <div class="stat__value">RM <%= formatMoney((summary && summary.gross_cents) ? summary.gross_cents : 0) %></div>
  </div>
  <div class="card card--pad">
    <div class="stat__label">Refunds (confirmed)</div>
    <div class="stat__value">RM <%= formatMoney((summary && summary.refund_cents) ? summary.refund_cents : 0) %></div>
  </div>
  <div class="card card--pad">
    <div class="stat__label">Net</div>
    <div class="stat__value">RM <%= formatMoney((summary && summary.net_cents) ? summary.net_cents : 0) %></div>
  </div>
</div>

<div class="card card--pad card--mt">
  <div class="card__header">
    <div>
      <div class="card__title">Trend</div>
      <div class="card__subtitle">Gross and net over the selected date range.</div>
    </div>
    <div class="muted small" style="text-align:right">Blue: Gross, Gray: Net</div>
  </div>

  <canvas class="report-chart" data-sales-daily='<%- JSON.stringify(daily || []) %>' height="180" aria-label="Sales trend chart" role="img"></canvas>
</div>

<div class="card card--pad card--mt">
  <div class="card__header" style="margin-bottom:6px">
    <div>
      <div class="card__title">Daily</div>
      <div class="card__subtitle">Gross is grouped by order created date; refunds are grouped by refund created date.</div>
    </div>
  </div>

  <div class="table-scroll" style="margin-top:10px">
    <table class="table">
      <thead>
        <tr><th>Date</th><th>Paid orders</th><th>Gross</th><th>Refunds</th><th>Net</th></tr>
      </thead>
      <tbody>
        <% if (daily && daily.length) { %>
          <% daily.forEach(r => { %>
            <tr>
              <td class="muted"><%= r.day %></td>
              <td><%= r.orders_count %></td>
              <td>RM <%= formatMoney(r.gross_cents || 0) %></td>
              <td>RM <%= formatMoney(r.refund_cents || 0) %></td>
              <td>RM <%= formatMoney(r.net_cents || 0) %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="5" class="muted">No data for this range.</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<div class="card card--pad card--mt">
  <div class="card__header" style="margin-bottom:6px">
    <div>
      <div class="card__title">Top products</div>
      <div class="card__subtitle">By gross item subtotal within paid orders.</div>
    </div>
  </div>

  <div class="table-scroll" style="margin-top:10px">
    <table class="table">
      <thead>
        <tr><th>Product</th><th>Qty</th><th>Subtotal</th></tr>
      </thead>
      <tbody>
        <% if (topProducts && topProducts.length) { %>
          <% topProducts.forEach(p => { %>
            <tr>
              <td><%= p.product_name %></td>
              <td><%= p.quantity %></td>
              <td>RM <%= formatMoney(p.subtotal_cents || 0) %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="3" class="muted">No data for this range.</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script src="/public/js/sales-report-chart.js" defer></script>

<%- include('../shared/bottom') %>
