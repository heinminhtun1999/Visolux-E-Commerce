<%- include('../shared/top', { title }) %>

<div class="actions icon-row" style="margin-bottom:12px">
  <a class="btn btn-icon" href="/admin/products" title="Back" aria-label="Back" data-label="Back"><%- icon('back') %></a>
</div>

<div class="card" style="padding:16px; width:100%">
  <h1 class="h1"><%= product ? ('Edit #' + product.product_id) : 'New product' %></h1>

  <form method="post" action="<%= product ? ('/admin/products/' + product.product_id + '/edit') : '/admin/products/new' %>" enctype="multipart/form-data">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
    <label>Name</label>
    <input class="input" name="name" value="<%= product ? product.name : '' %>" required />

    <label>Description</label>
    <textarea class="input" name="description" rows="6" data-product-desc-textarea><%= product ? product.description : '' %></textarea>
    <textarea name="description_html" style="display:none" data-product-desc-html><%- product ? (product.description_html || '') : '' %></textarea>
    <div class="rte" data-product-desc-editor style="display:none; margin-top:10px">
      <div class="ql-toolbar ql-snow" data-product-desc-toolbar></div>
      <div class="rte__editor" style="min-height:160px"></div>
      <div class="muted small" style="margin-top:6px">Images are disabled in the description. Use the gallery upload below.</div>
    </div>

    <label>Category</label>
    <select name="category" required>
      <% if (!categories || !categories.length) { %>
        <option value="" disabled selected>No categories yet</option>
      <% } else { %>
        <% categories.forEach(c => { %>
          <option value="<%= c.slug %>" <%= product && product.category===c.slug ? 'selected' : '' %>><%= c.name %></option>
        <% }) %>
      <% } %>
    </select>

    <div class="row">
      <div class="col" style="min-width:220px">
        <label>Selling price (RM)</label>
        <input class="input" name="price" type="number" min="1" step="0.01" value="<%= product ? (product.price/100).toFixed(2) : '1.00' %>" required />
      </div>
      <div class="col" style="min-width:220px">
        <label>Cost price (RM)</label>
        <input class="input" name="cost_price" type="number" min="0" step="0.01" value="<%= (product && product.cost_price != null) ? (product.cost_price/100).toFixed(2) : '' %>" placeholder="e.g. 8.50" />
        <div class="muted small" style="margin-top:6px">Optional. Used for reports and profit calculations.</div>
      </div>
      <div class="col" style="min-width:220px">
        <label>Stock</label>
        <input class="input" name="stock" type="number" min="0" value="<%= product ? product.stock : 0 %>" required />
      </div>
    </div>

    <div class="row">
      <div class="col" style="min-width:220px">
        <label>Weight (kg)</label>
        <input class="input" name="weight_kg" type="number" min="0" step="0.001" value="<%= (product && product.weight_kg != null) ? product.weight_kg : '' %>" placeholder="e.g. 0.35" />
      </div>
      <div class="col" style="min-width:220px">
        <label>Height (cm)</label>
        <input class="input" name="height_cm" type="number" min="0" step="0.1" value="<%= (product && product.height_cm != null) ? product.height_cm : '' %>" placeholder="e.g. 10" />
      </div>
      <div class="col" style="min-width:220px">
        <label>Length (cm)</label>
        <input class="input" name="length_cm" type="number" min="0" step="0.1" value="<%= (product && product.length_cm != null) ? product.length_cm : '' %>" placeholder="e.g. 20" />
      </div>
      <div class="col" style="min-width:220px">
        <label>Width (cm)</label>
        <input class="input" name="width_cm" type="number" min="0" step="0.1" value="<%= (product && product.width_cm != null) ? product.width_cm : '' %>" placeholder="e.g. 15" />
      </div>
    </div>

    <div class="row">
      <div class="col" style="min-width:220px">
        <label>Visibility</label>
        <select name="visibility">
          <option value="1" <%= !product || product.visibility ? 'selected' : '' %>>Visible</option>
          <option value="0" <%= product && !product.visibility ? 'selected' : '' %>>Hidden</option>
        </select>
      </div>
      <div class="col" style="min-width:220px">
        <label>Archived</label>
        <select name="archived">
          <option value="0" <%= !product || !product.archived ? 'selected' : '' %>>No</option>
          <option value="1" <%= product && product.archived ? 'selected' : '' %>>Yes</option>
        </select>
      </div>
    </div>

    <label>Product images</label>
    <input class="input" type="file" name="product_images" accept="image/*" multiple />
    <div class="muted small" style="margin-top:6px">Tip: the first image becomes the main product image; the rest become gallery images.</div>

    <% if (product && product.product_image) { %>
      <div style="margin-top:12px">
        <div class="muted small" style="margin-bottom:6px">Main image</div>
        <img class="product-img" style="height:220px" src="<%= product.product_image %>" alt="" />
      </div>
    <% } %>

    <div class="actions" style="margin-top:12px">
      <button class="btn btn-primary btn-icon" type="submit" title="Save" aria-label="Save" data-label="Save"><%- icon('check') %></button>
      <a class="btn btn-icon" href="/admin/products" title="Cancel" aria-label="Cancel" data-label="Cancel"><%- icon('x') %></a>
    </div>
  </form>

  <% if (product && images && images.length) { %>
    <hr class="divider" />
    <div class="muted small" style="margin-bottom:8px">Gallery images</div>
    <div class="grid" style="grid-template-columns:repeat(auto-fill, minmax(160px, 1fr))">
      <% images.forEach(img => { %>
        <div class="card" style="padding:10px">
          <img class="product-img" style="height:120px" src="<%= img.image_url %>" alt="" />
          <form method="post" action="/admin/products/<%= product.product_id %>/images/<%= img.id %>/delete" style="margin-top:8px">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <button class="btn btn-icon" type="submit" title="Delete" aria-label="Delete" data-label="Delete"><%- icon('trash') %></button>
          </form>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js" defer></script>
<script src="/public/js/admin-product-editor.js" defer></script>

<%- include('../shared/bottom') %>
